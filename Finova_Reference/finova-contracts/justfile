# Finova Network - Modern Command Runner
# Version: 1.0.0
# Description: Enterprise-grade justfile for comprehensive project management
# Usage: just <command> [args]

# Default recipe - shows available commands
default:
    @just --list

# Environment variables with defaults
export RUST_LOG := env_var_or_default("RUST_LOG", "info")
export ANCHOR_PROVIDER_URL := env_var_or_default("ANCHOR_PROVIDER_URL", "https://api.devnet.solana.com")
export SOLANA_CLUSTER := env_var_or_default("SOLANA_CLUSTER", "devnet")
export NODE_ENV := env_var_or_default("NODE_ENV", "development")
export DATABASE_URL := env_var_or_default("DATABASE_URL", "postgresql://localhost:5432/finova_dev")
export REDIS_URL := env_var_or_default("REDIS_URL", "redis://localhost:6379")

# Project information
version := "1.0.0"
project_name := "finova-network"
repo_url := "https://github.com/finova-network/finova-contracts"

# =============================================================================
# SETUP & INSTALLATION
# =============================================================================

# Initial project setup for new developers
setup: install-deps build-all setup-env
    @echo "ğŸš€ Finova Network setup complete!"
    @echo "ğŸ“– Read README.md for next steps"
    @echo "ğŸ”§ Run 'just dev' to start development environment"

# Install all dependencies
install-deps: install-rust-deps install-node-deps install-python-deps
    @echo "âœ… All dependencies installed"

# Install Rust dependencies and tools
install-rust-deps:
    @echo "ğŸ¦€ Installing Rust dependencies..."
    rustup update stable
    rustup component add rustfmt clippy
    cargo install --force anchor-cli
    cargo install --force solana-cli
    cargo install --force spl-token-cli
    @echo "âœ… Rust dependencies installed"

# Install Node.js dependencies
install-node-deps:
    @echo "ğŸ“¦ Installing Node.js dependencies..."
    npm install -g yarn
    yarn install
    @echo "âœ… Node.js dependencies installed"

# Install Python dependencies for AI services
install-python-deps:
    @echo "ğŸ Installing Python dependencies..."
    pip install --upgrade pip
    pip install poetry
    poetry install
    @echo "âœ… Python dependencies installed"

# Setup environment files
setup-env:
    @echo "ğŸ”§ Setting up environment files..."
    cp .env.example .env
    @echo "ğŸ“ Please configure .env file with your settings"
    @echo "âœ… Environment setup complete"

# =============================================================================
# BUILD COMMANDS
# =============================================================================

# Build all components
build-all: build-programs build-client build-mobile build-ai
    @echo "ğŸ—ï¸ All components built successfully"

# Build all Anchor programs
build-programs:
    @echo "ğŸ”¨ Building Anchor programs..."
    anchor build
    @echo "âœ… Programs built successfully"

# Build specific program
build-program program:
    @echo "ğŸ”¨ Building {{program}} program..."
    cd programs/{{program}} && cargo build-bpf
    @echo "âœ… {{program}} built successfully"

# Build client SDKs
build-client: build-typescript-sdk build-rust-sdk build-python-sdk
    @echo "âœ… All client SDKs built"

# Build TypeScript SDK
build-typescript-sdk:
    @echo "ğŸ“¦ Building TypeScript SDK..."
    cd client/typescript && yarn build
    @echo "âœ… TypeScript SDK built"

# Build Rust SDK
build-rust-sdk:
    @echo "ğŸ¦€ Building Rust SDK..."
    cd client/rust && cargo build --release
    @echo "âœ… Rust SDK built"

# Build Python SDK
build-python-sdk:
    @echo "ğŸ Building Python SDK..."
    cd client/python && poetry build
    @echo "âœ… Python SDK built"

# Build mobile SDKs
build-mobile: build-ios-sdk build-android-sdk build-react-native-sdk
    @echo "âœ… All mobile SDKs built"

# Build iOS SDK
build-ios-sdk:
    @echo "ğŸ“± Building iOS SDK..."
    cd mobile-sdk/ios && xcodebuild -scheme FinovaSDK -configuration Release
    @echo "âœ… iOS SDK built"

# Build Android SDK
build-android-sdk:
    @echo "ğŸ¤– Building Android SDK..."
    cd mobile-sdk/android && ./gradlew build
    @echo "âœ… Android SDK built"

# Build React Native SDK
build-react-native-sdk:
    @echo "âš›ï¸ Building React Native SDK..."
    cd mobile-sdk/react-native && yarn build
    @echo "âœ… React Native SDK built"

# Build AI services
build-ai:
    @echo "ğŸ¤– Building AI services..."
    cd ai-services && docker-compose build
    @echo "âœ… AI services built"

# Clean all build artifacts
clean: clean-programs clean-client clean-mobile clean-ai
    @echo "ğŸ§¹ All build artifacts cleaned"

# Clean program builds
clean-programs:
    @echo "ğŸ§¹ Cleaning program builds..."
    anchor clean
    rm -rf target/
    @echo "âœ… Program builds cleaned"

# Clean client builds
clean-client:
    @echo "ğŸ§¹ Cleaning client builds..."
    cd client/typescript && rm -rf dist/ node_modules/
    cd client/rust && cargo clean
    cd client/python && rm -rf dist/ build/
    @echo "âœ… Client builds cleaned"

# Clean mobile builds
clean-mobile:
    @echo "ğŸ§¹ Cleaning mobile builds..."
    cd mobile-sdk/ios && rm -rf build/
    cd mobile-sdk/android && ./gradlew clean
    cd mobile-sdk/react-native && rm -rf dist/ node_modules/
    @echo "âœ… Mobile builds cleaned"

# Clean AI services
clean-ai:
    @echo "ğŸ§¹ Cleaning AI services..."
    cd ai-services && docker-compose down --volumes --remove-orphans
    @echo "âœ… AI services cleaned"

# =============================================================================
# TESTING
# =============================================================================

# Run all tests
test-all: test-programs test-client test-integration test-security
    @echo "âœ… All tests completed successfully"

# Run program tests only
test-programs:
    @echo "ğŸ§ª Running program tests..."
    anchor test
    @echo "âœ… Program tests completed"

# Run specific program tests
test-program program:
    @echo "ğŸ§ª Testing {{program}} program..."
    cd programs/{{program}} && cargo test
    @echo "âœ… {{program}} tests completed"

# Run client SDK tests
test-client:
    @echo "ğŸ§ª Testing client SDKs..."
    cd client/typescript && yarn test
    cd client/rust && cargo test
    cd client/python && poetry run pytest
    @echo "âœ… Client tests completed"

# Run integration tests
test-integration:
    @echo "ğŸ§ª Running integration tests..."
    cd tests/integration && yarn test
    @echo "âœ… Integration tests completed"

# Run security tests
test-security:
    @echo "ğŸ”’ Running security tests..."
    cd tests/security && yarn test
    @echo "âœ… Security tests completed"

# Run end-to-end tests
test-e2e:
    @echo "ğŸ§ª Running E2E tests..."
    cd tests/e2e && yarn test
    @echo "âœ… E2E tests completed"

# Run load tests
test-load:
    @echo "âš¡ Running load tests..."
    cd tools/testing/load-testing && k6 run api-load-test.js
    @echo "âœ… Load tests completed"

# Run tests with coverage
test-coverage:
    @echo "ğŸ“Š Running tests with coverage..."
    anchor test --coverage
    cd client/typescript && yarn test --coverage
    cd client/rust && cargo tarpaulin --out Html
    @echo "âœ… Coverage tests completed"

# =============================================================================
# DEVELOPMENT
# =============================================================================

# Start development environment
dev: dev-blockchain dev-api dev-ai
    @echo "ğŸš€ Development environment started"
    @echo "ğŸŒ API: http://localhost:3000"
    @echo "ğŸ”— Blockchain: http://localhost:8899"
    @echo "ğŸ¤– AI Services: http://localhost:8080"

# Start local blockchain
dev-blockchain:
    @echo "â›“ï¸ Starting local blockchain..."
    solana-test-validator \
        --bpf-program $(anchor keys list | grep finova-core | cut -d' ' -f1) target/deploy/finova_core.so \
        --bpf-program $(anchor keys list | grep finova-token | cut -d' ' -f1) target/deploy/finova_token.so \
        --bpf-program $(anchor keys list | grep finova-nft | cut -d' ' -f1) target/deploy/finova_nft.so \
        --reset \
        --quiet &
    @echo "âœ… Local blockchain started on port 8899"

# Start API development server
dev-api:
    @echo "ğŸŒ Starting API server..."
    cd api && yarn dev &
    @echo "âœ… API server started on port 3000"

# Start AI services
dev-ai:
    @echo "ğŸ¤– Starting AI services..."
    cd ai-services && docker-compose up -d
    @echo "âœ… AI services started"

# Stop development environment
dev-stop:
    @echo "ğŸ›‘ Stopping development environment..."
    pkill -f solana-test-validator || true
    pkill -f "yarn dev" || true
    cd ai-services && docker-compose down
    @echo "âœ… Development environment stopped"

# Watch and rebuild on changes
watch component:
    @echo "ğŸ‘€ Watching {{component}} for changes..."
    @case "{{component}}" in \
        "programs") watchexec -w programs "just build-programs" ;; \
        "client") watchexec -w client "just build-client" ;; \
        "api") cd api && yarn dev ;; \
        *) echo "âŒ Unknown component: {{component}}" ;; \
    esac

# Format all code
format: format-rust format-typescript format-python
    @echo "âœ¨ All code formatted"

# Format Rust code
format-rust:
    @echo "ğŸ¦€ Formatting Rust code..."
    cargo fmt --all
    @echo "âœ… Rust code formatted"

# Format TypeScript code
format-typescript:
    @echo "ğŸ“ Formatting TypeScript code..."
    yarn prettier --write "**/*.{ts,js,json}"
    @echo "âœ… TypeScript code formatted"

# Format Python code
format-python:
    @echo "ğŸ Formatting Python code..."
    cd ai-services && poetry run black .
    cd ai-services && poetry run isort .
    @echo "âœ… Python code formatted"

# Lint all code
lint: lint-rust lint-typescript lint-python
    @echo "ğŸ” All code linted"

# Lint Rust code
lint-rust:
    @echo "ğŸ¦€ Linting Rust code..."
    cargo clippy --all-targets --all-features -- -D warnings
    @echo "âœ… Rust code linted"

# Lint TypeScript code
lint-typescript:
    @echo "ğŸ“ Linting TypeScript code..."
    yarn eslint "**/*.{ts,js}" --fix
    @echo "âœ… TypeScript code linted"

# Lint Python code
lint-python:
    @echo "ğŸ Linting Python code..."
    cd ai-services && poetry run flake8 .
    cd ai-services && poetry run mypy .
    @echo "âœ… Python code linted"

# =============================================================================
# DEPLOYMENT
# =============================================================================

# Deploy to devnet
deploy-devnet: build-programs
    @echo "ğŸš€ Deploying to devnet..."
    anchor deploy --provider.cluster devnet
    @echo "âœ… Deployed to devnet successfully"

# Deploy to testnet
deploy-testnet: build-programs
    @echo "ğŸš€ Deploying to testnet..."
    anchor deploy --provider.cluster testnet
    @echo "âœ… Deployed to testnet successfully"

# Deploy to mainnet (requires confirmation)
deploy-mainnet: build-programs
    @echo "âš ï¸  MAINNET DEPLOYMENT - This will deploy to production!"
    @echo "Press Ctrl+C to cancel, or Enter to continue..."
    @read confirm
    anchor deploy --provider.cluster mainnet-beta
    @echo "âœ… Deployed to mainnet successfully"

# Deploy API to staging
deploy-api-staging:
    @echo "ğŸŒ Deploying API to staging..."
    cd api && docker build -t finova-api:staging .
    cd infrastructure/kubernetes && kubectl apply -f deployments/api-deployment.yaml
    @echo "âœ… API deployed to staging"

# Deploy API to production
deploy-api-production:
    @echo "ğŸŒ Deploying API to production..."
    cd api && docker build -t finova-api:production .
    cd infrastructure/kubernetes && kubectl apply -f deployments/api-deployment.yaml
    @echo "âœ… API deployed to production"

# Deploy AI services
deploy-ai environment:
    @echo "ğŸ¤– Deploying AI services to {{environment}}..."
    cd ai-services && docker-compose -f docker-compose.{{environment}}.yml up -d
    @echo "âœ… AI services deployed to {{environment}}"

# =============================================================================
# DATABASE & MIGRATIONS
# =============================================================================

# Setup database
db-setup:
    @echo "ğŸ—„ï¸ Setting up database..."
    createdb finova_dev || true
    createdb finova_test || true
    just db-migrate
    @echo "âœ… Database setup complete"

# Run database migrations
db-migrate:
    @echo "ğŸ—„ï¸ Running database migrations..."
    cd database/migrations && node migrate.js
    @echo "âœ… Database migrations completed"

# Rollback database migration
db-rollback:
    @echo "ğŸ”„ Rolling back database migration..."
    cd database/migrations && node rollback.js
    @echo "âœ… Database rollback completed"

# Seed database with test data
db-seed:
    @echo "ğŸŒ± Seeding database..."
    cd database/seeds && node seed.js
    @echo "âœ… Database seeded"

# Reset database (drop, create, migrate, seed)
db-reset:
    @echo "ğŸ”„ Resetting database..."
    dropdb finova_dev || true
    dropdb finova_test || true
    just db-setup
    just db-seed
    @echo "âœ… Database reset complete"

# Backup database
db-backup:
    @echo "ğŸ’¾ Backing up database..."
    pg_dump finova_dev > backups/finova_dev_$(date +%Y%m%d_%H%M%S).sql
    @echo "âœ… Database backup created"

# =============================================================================
# DOCKER & CONTAINERS
# =============================================================================

# Build all Docker images
docker-build:
    @echo "ğŸ³ Building Docker images..."
    docker-compose build
    @echo "âœ… Docker images built"

# Start all services with Docker
docker-up:
    @echo "ğŸ³ Starting Docker services..."
    docker-compose up -d
    @echo "âœ… Docker services started"

# Stop all Docker services
docker-down:
    @echo "ğŸ³ Stopping Docker services..."
    docker-compose down
    @echo "âœ… Docker services stopped"

# View Docker logs
docker-logs service="":
    @if [ "{{service}}" = "" ]; then \
        docker-compose logs -f; \
    else \
        docker-compose logs -f {{service}}; \
    fi

# Clean Docker resources
docker-clean:
    @echo "ğŸ§¹ Cleaning Docker resources..."
    docker-compose down --volumes --remove-orphans
    docker system prune -f
    @echo "âœ… Docker resources cleaned"

# =============================================================================
# SECURITY & AUDITING
# =============================================================================

# Run security audit
security-audit: security-audit-rust security-audit-node security-audit-python
    @echo "ğŸ”’ Security audit completed"

# Audit Rust dependencies
security-audit-rust:
    @echo "ğŸ”’ Auditing Rust dependencies..."
    cargo audit
    @echo "âœ… Rust audit completed"

# Audit Node.js dependencies
security-audit-node:
    @echo "ğŸ”’ Auditing Node.js dependencies..."
    yarn audit
    @echo "âœ… Node.js audit completed"

# Audit Python dependencies
security-audit-python:
    @echo "ğŸ”’ Auditing Python dependencies..."
    cd ai-services && poetry audit
    @echo "âœ… Python audit completed"

# Run vulnerability scan
security-scan:
    @echo "ğŸ”’ Running vulnerability scan..."
    cd tools/security && ./vulnerability-scan.sh
    @echo "âœ… Vulnerability scan completed"

# Generate security report
security-report:
    @echo "ğŸ“Š Generating security report..."
    cd security/audits && ./generate-report.sh
    @echo "âœ… Security report generated"

# =============================================================================
# MONITORING & ANALYTICS
# =============================================================================

# Start monitoring stack
monitoring-start:
    @echo "ğŸ“Š Starting monitoring stack..."
    cd infrastructure/monitoring && docker-compose up -d
    @echo "âœ… Monitoring stack started"
    @echo "ğŸ“Š Grafana: http://localhost:3001"
    @echo "ğŸ”¥ Prometheus: http://localhost:9090"

# Stop monitoring stack
monitoring-stop:
    @echo "ğŸ“Š Stopping monitoring stack..."
    cd infrastructure/monitoring && docker-compose down
    @echo "âœ… Monitoring stack stopped"

# View system health
health-check:
    @echo "ğŸ¥ Checking system health..."
    curl -f http://localhost:3000/health || echo "âŒ API unhealthy"
    curl -f http://localhost:8899/health || echo "âŒ Blockchain unhealthy"
    docker ps --filter "status=running" --format "table {{.Names}}\t{{.Status}}"
    @echo "âœ… Health check completed"

# Generate analytics report
analytics-report:
    @echo "ğŸ“ˆ Generating analytics report..."
    cd tools/analytics && python generate_report.py
    @echo "âœ… Analytics report generated"

# =============================================================================
# MAINTENANCE & UTILITIES
# =============================================================================

# Update all dependencies
update-deps: update-rust-deps update-node-deps update-python-deps
    @echo "â¬†ï¸ All dependencies updated"

# Update Rust dependencies
update-rust-deps:
    @echo "ğŸ¦€ Updating Rust dependencies..."
    cargo update
    @echo "âœ… Rust dependencies updated"

# Update Node.js dependencies
update-node-deps:
    @echo "ğŸ“¦ Updating Node.js dependencies..."
    yarn upgrade
    @echo "âœ… Node.js dependencies updated"

# Update Python dependencies
update-python-deps:
    @echo "ğŸ Updating Python dependencies..."
    cd ai-services && poetry update
    @echo "âœ… Python dependencies updated"

# Generate documentation
docs-generate:
    @echo "ğŸ“š Generating documentation..."
    cargo doc --no-deps --open
    cd client/typescript && yarn docs
    @echo "âœ… Documentation generated"

# Serve documentation locally
docs-serve:
    @echo "ğŸ“š Serving documentation..."
    cd docs && python -m http.server 8000
    @echo "ğŸ“š Documentation available at http://localhost:8000"

# Create new release
release version:
    @echo "ğŸš€ Creating release {{version}}..."
    git tag -a v{{version}} -m "Release {{version}}"
    git push origin v{{version}}
    @echo "âœ… Release {{version}} created"

# Show project statistics
stats:
    @echo "ğŸ“Š Project Statistics"
    @echo "===================="
    @echo "Version: {{version}}"
    @echo "Repository: {{repo_url}}"
    @echo ""
    @echo "Code Statistics:"
    @find . -name "*.rs" -type f | wc -l | sed 's/^/  Rust files: /'
    @find . -name "*.ts" -name "*.js" -type f | wc -l | sed 's/^/  TypeScript\/JS files: /'
    @find . -name "*.py" -type f | wc -l | sed 's/^/  Python files: /'
    @echo ""
    @echo "Lines of Code:"
    @find . -name "*.rs" -type f -exec wc -l {} + | tail -1 | sed 's/^/  Rust: /'
    @find . -name "*.ts" -name "*.js" -type f -exec wc -l {} + | tail -1 | sed 's/^/  TypeScript\/JS: /'
    @find . -name "*.py" -type f -exec wc -l {} + | tail -1 | sed 's/^/  Python: /'

# Show environment information
env-info:
    @echo "ğŸ”§ Environment Information"
    @echo "========================="
    @echo "Rust version: $(rustc --version)"
    @echo "Cargo version: $(cargo --version)"
    @echo "Node.js version: $(node --version)"
    @echo "Yarn version: $(yarn --version)"
    @echo "Python version: $(python --version)"
    @echo "Docker version: $(docker --version)"
    @echo "Solana CLI version: $(solana --version)"
    @echo "Anchor CLI version: $(anchor --version)"
    @echo ""
    @echo "Environment Variables:"
    @echo "  SOLANA_CLUSTER: $SOLANA_CLUSTER"
    @echo "  NODE_ENV: $NODE_ENV"
    @echo "  RUST_LOG: $RUST_LOG"

# Help command with detailed usage
help:
    @echo "ğŸš€ Finova Network - Development Commands"
    @echo "========================================"
    @echo ""
    @echo "ğŸ”§ Setup & Installation:"
    @echo "  setup           - Complete project setup for new developers"
    @echo "  install-deps    - Install all dependencies"
    @echo ""
    @echo "ğŸ—ï¸ Build Commands:"
    @echo "  build-all       - Build all components"
    @echo "  build-programs  - Build Anchor programs"
    @echo "  build-client    - Build client SDKs"
    @echo "  clean           - Clean all build artifacts"
    @echo ""
    @echo "ğŸ§ª Testing:"
    @echo "  test-all        - Run all tests"
    @echo "  test-programs   - Run program tests only"
    @echo "  test-security   - Run security tests"
    @echo ""
    @echo "ğŸš€ Development:"
    @echo "  dev             - Start development environment"
    @echo "  dev-stop        - Stop development environment"
    @echo "  format          - Format all code"
    @echo "  lint            - Lint all code"
    @echo ""
    @echo "ğŸš€ Deployment:"
    @echo "  deploy-devnet   - Deploy to devnet"
    @echo "  deploy-testnet  - Deploy to testnet"
    @echo "  deploy-mainnet  - Deploy to mainnet"
    @echo ""
    @echo "ğŸ—„ï¸ Database:"
    @echo "  db-setup        - Setup database"
    @echo "  db-migrate      - Run migrations"
    @echo "  db-seed         - Seed test data"
    @echo ""
    @echo "ğŸ”’ Security:"
    @echo "  security-audit  - Run security audit"
    @echo "  security-scan   - Run vulnerability scan"
    @echo ""
    @echo "ğŸ“Š Monitoring:"
    @echo "  health-check    - Check system health"
    @echo "  monitoring-start - Start monitoring stack"
    @echo ""
    @echo "ğŸ› ï¸ Utilities:"
    @echo "  stats           - Show project statistics"
    @echo "  env-info        - Show environment information"
    @echo "  help            - Show detailed help"
    @echo ""
    @echo "For more commands, run: just --list"
	